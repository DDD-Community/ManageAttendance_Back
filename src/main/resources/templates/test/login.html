<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Login Test</title>
    <meta charset="UTF-8">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script type="text/javascript" src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .btn { display: block; width: 100%; padding: 10px; margin: 10px 0; background: #eee; text-align: center; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <h2>Social Login Test</h2>
    
    <!-- Google Login -->
    <div id="g_id_onload"
         th:data-client_id="${googleClientId}"
         data-callback="handleGoogleCredentialResponse"
         data-auto_select="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>

    <hr/>

    <!-- Apple Login -->
    <div id="appleid-signin" class="btn" onclick="signInApple()">Sign in with Apple</div>

    <div id="message" style="color: red; margin-top: 10px;"></div>
</div>

<script>
    // Google Handler
    function handleGoogleCredentialResponse(response) {
        console.log("Google Token:", response.credential);
        login('GOOGLE', response.credential);
    }

    // Apple Init (Placeholder - needs actual Client ID from properties if available)
    // Apple.ID.auth.init({ ... });

    function signInApple() {
        // For testing, typically requires valid redirect setup or JS configuration.
        // Assuming we might manually input token or simulated flow for now if keys aren't set.
        alert("Apple Sign-In requires valid Client ID and Redirect URI configuration via JS.");
    }

    function login(provider, token) {
        axios.post('/api/auth/login', {
            provider: provider,
            token: token
        })
        .then(function (response) {
            console.log("Login Success:", response.data);
            const accessToken = response.data.accessToken;
            const refreshToken = response.data.refreshToken;
            
            localStorage.setItem('accessToken', accessToken);
            localStorage.setItem('refreshToken', refreshToken);
            // Store OAuth token for Withdrawal/Revocation use
            localStorage.setItem('oauth_provider_token', token);
            
            window.location.href = '/test/my';
        })
        .catch(function (error) {
            console.error("Login Failed:", error);
            if (error.response && error.response.status === 404) {
                // User not found -> Redirect to Register passing token/provider
                alert("회원이 아닙니다. 회원가입 페이지로 이동합니다.");
                localStorage.setItem('temp_token', token);
                localStorage.setItem('temp_provider', provider);
                window.location.href = '/test/register';
            } else {
                document.getElementById('message').innerText = "Login Failed: " + (error.response ? error.response.data.message : error.message);
            }
        });
    }
</script>
</body>
</html>
