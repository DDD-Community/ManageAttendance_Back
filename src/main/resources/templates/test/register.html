<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Register Test</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h2>Register</h2>
    
    <!-- Invitation Code Verification -->
    <div class="form-group">
        <label>Invitation Code</label>
        <input type="text" id="invitationCode" placeholder="Enter code">
        <button type="button" onclick="verifyCode()" style="margin-top: 5px;">Verify Code</button>
    </div>

    <!-- Registration Form (Hidden until verified) -->
    <div id="registerForm" class="hidden">
        <div class="form-group">
            <label>Provider</label>
            <input type="text" id="provider" readonly>
        </div>
        
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" placeholder="Name">
        </div>

        <div class="form-group">
            <label>Generation</label>
            <input type="text" id="generationName" readonly>
            <input type="hidden" id="generationId">
        </div>

        <div class="form-group">
            <label>Role</label>
            <input type="text" id="role" readonly>
        </div>

        <div class="form-group">
            <label>Job Role</label>
            <select id="jobRole">
                <!-- Loaded via API -->
            </select>
        </div>

        <!-- Team (Only for MEMBER) -->
        <div id="teamSection" class="form-group hidden">
            <label>Team</label>
            <select id="teamId">
                <option value="">Select Team</option>
            </select>
        </div>

        <!-- Manager Roles (Only for MANAGER) -->
        <div id="managerRolesSection" class="form-group hidden">
            <label>Manager Roles</label>
            <div id="managerRolesContainer">
                <!-- Checkboxes loaded via API -->
            </div>
        </div>

        <button type="button" onclick="registerUser()">Complete Registration</button>
    </div>

    <div id="message" style="color: red; margin-top: 10px;"></div>
</div>

<script>
    const provider = localStorage.getItem('temp_provider');
    const token = localStorage.getItem('temp_token');

    if (!provider || !token) {
        alert("No OAuth info found. Redirecting to login.");
        window.location.href = '/test/login';
    }

    document.getElementById('provider').value = provider;

    // Load Job Roles on Init
    axios.get('/api/onboarding/jobs').then(res => {
        const select = document.getElementById('jobRole');
        res.data.forEach(job => {
            const option = document.createElement('option');
            option.value = job.key;
            option.text = job.text; // Assuming response has key/text
            select.appendChild(option);
        });
    });

    function verifyCode() {
        const code = document.getElementById('invitationCode').value;
        axios.get('/api/onboarding/verify-code?code=' + code)
            .then(res => {
                const data = res.data;
                // data: { generationId, generationName, type (MEMBER/MANAGER), description }
                
                document.getElementById('generationId').value = data.generationId;
                document.getElementById('generationName').value = data.generationName;
                document.getElementById('role').value = data.type;
                
                const registerForm = document.getElementById('registerForm');
                registerForm.classList.remove('hidden');

                // Toggle sections based on Role
                if (data.type === 'MEMBER') {
                    document.getElementById('teamSection').classList.remove('hidden');
                    document.getElementById('managerRolesSection').classList.add('hidden');
                    loadTeams(data.generationId);
                } else if (data.type === 'MANAGER') {
                    document.getElementById('teamSection').classList.add('hidden');
                    document.getElementById('managerRolesSection').classList.remove('hidden');
                    loadManagerRoles();
                }
            })
            .catch(err => {
                alert("Invalid Code: " + (err.response ? err.response.data.message : err.message));
            });
    }

    function loadTeams(generationId) {
        axios.get('/api/onboarding/teams?generationId=' + generationId)
            .then(res => {
                const select = document.getElementById('teamId');
                select.innerHTML = '<option value="">Select Team</option>';
                res.data.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.teamId;
                    option.text = team.name;
                    select.appendChild(option);
                });
            });
    }

    function loadManagerRoles() {
        const container = document.getElementById('managerRolesContainer');
        if (container.children.length > 0) return; // Already loaded

        axios.get('/api/onboarding/manager-roles')
            .then(res => {
                res.data.forEach(role => {
                    const div = document.createElement('div');
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.name = 'managerRoles';
                    cb.value = role.key;
                    
                    const span = document.createElement('span');
                    span.innerText = role.text;
                    
                    div.appendChild(cb);
                    div.appendChild(span);
                    container.appendChild(div);
                });
            });
    }

    function registerUser() {
        const role = document.getElementById('role').value;
        
        const payload = {
            provider: provider,
            token: token,
            name: document.getElementById('name').value,
            invitationCode: document.getElementById('invitationCode').value,
            jobRole: document.getElementById('jobRole').value,
            generationId: parseInt(document.getElementById('generationId').value),
            teamId: null,
            managerRoles: []
        };

        if (role === 'MEMBER') {
             const teamVal = document.getElementById('teamId').value;
             if (teamVal) payload.teamId = parseInt(teamVal);
        } else if (role === 'MANAGER') {
            const checkboxes = document.querySelectorAll('input[name="managerRoles"]:checked');
            checkboxes.forEach(cb => payload.managerRoles.push(cb.value));
        }

        axios.post('/api/users', payload)
            .then(res => {
                const accessToken = res.data.accessToken; // Check if Register returns Token or just UserInfo? 
                // Ah, UserController.registerUser returns UserInfoResponse, NOT LoginResponse (Token).
                // So we need to Login again or handle this.
                // Wait, typically Register assumes auto-login or prompts to login.
                // Let's check UserController.
                
                alert("Registration Successful! Please Login.");
                window.location.href = '/test/login';
            })
            .catch(err => {
                 document.getElementById('message').innerText = "Register Failed: " + (err.response ? JSON.stringify(err.response.data) : err.message);
            });
    }
</script>
</body>
</html>
